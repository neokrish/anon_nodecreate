<?php
// $Id$
/**
 * @file anon_nodecreate.module
 * TODO: Enter file description here.
 */

define("NEWUSER", "0");
define("EXISTINGUSER", "1");
define("ANONUSER", "2");


/**
 * Implementation of hook_menu().
 */
function anon_nodecreate_menu() { 
  
  $items['admin/settings/anon_nodecreate'] = array(
    'title' => 'Anon Node Create Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('anon_nodecreate_settings'),
    'access arguments' => array('access content'), 
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}


/**
 * Implementation of hook_nodeapi().
 */
function anon_nodecreate_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  switch ($op) {
    case 'insert':
      if($_SESSION ['anon_user']) {
        $user = $_SESSION ['anon_user']['user'];
	if($_SESSION ['anon_user']['type'] == NEWUSER) {
          rules_invoke_event('anon_nodecreate_rules_newuser', $user);
          unset($_SESSION ['anon_user']);
        } else if($_SESSION ['anon_user']['type'] == EXISTINGUSER) {
	  rules_invoke_event('anon_nodecreate_rules_existinguser', $user);      
          unset($_SESSION ['anon_user']);
        }
      }
      break;
    case 'presave':
      if ($user = $_SESSION ['anon_user']['user']) $node->uid = $user->uid;
      break;
    case 'validate':
      // check if we are processing an anon node form submission.
      global $user;
      if(!($user->uid)) {
        $new_user = $node->anon_nodecreate['new_user'] ['form_fields'];
        $existing_user = $node->anon_nodecreate['existing_user'] ['form_fields'];
        $status = anon_nodecreate_validate_user_details($new_user, $existing_user);
          
	if($_SESSION ['anon_user']['immediate_login']) {
	 // global $user;
	 // $user = $status['user'];
	}
        
      }
      break;
  }
}

/**
 *
 */
function anon_nodecreate_validate_user_details($new_user, $existing_user) {
  if($new_user['name']) {
    // we are registering new user
    foreach($new_user as $key => $value) {
      $form_state['values'][$key] = $value;
    }   
    logintoboggan_user_register_submit($form, $form_state);
    //drupal_execute('user_register', $form_state);
    $_SESSION ['anon_user']['type'] = NEWUSER;
    $_SESSION ['anon_user']['immediate_login'] = TRUE;
    $_SESSION ['anon_user']['user'] = $form_state['user'];
    if($_SESSION ['anon_user']['immediate_login']) {
      global $user;
      $user = user_load($_SESSION ['anon_user']['user']->uid);
    }
  } 
  else if($existing_user['name']) {
      foreach($existing_user as $key => $value) {
	$form_state['values'][$key] = $value;
      }
     drupal_execute('user_login', $form_state);
     global $user;
     if($user->uid) {
	$_SESSION ['anon_user']['type'] = EXISTINGUSER;
	$_SESSION ['anon_user']['immediate_login'] = TRUE;
	$_SESSION ['anon_user']['user'] = $user;
     }
  } 
  else {
     $_SESSION ['anon_user']['type'] = ANONUSER;   
  }
  //drupal_execute('user_register',)
  return $status;
}
/**
 * Implementation of hook_form_alter().
 */
function anon_nodecreate_form_alter(&$form, &$form_state, $form_id) {
  global $user;

  if (((substr($form_id, -10)=='_node_form') && (!$user->uid))) {
    $form['anon_nodecreate'] = array(
      '#type' => 'fieldset',
      '#title' => t('User account details'),
      '#description' => t('You have either not logged in or do not have an account in this site. Please fill the relevant detail below to automatically associate your account to this content.'),
      '#collapsible' => TRUE,
      '#tree' => TRUE,
    );
    $form['anon_nodecreate']['new_user'] = array(
      '#type' => 'fieldset',
      '#title' => t('New User'),
      '#description' => t('If you are a new user, please type in your email and preferred username. You will receive your account information on email.'),
    );
    $form['anon_nodecreate'] ['new_user'] ['form_fields'] = anon_nodecreate_get_user_form('user_register');

    $form['anon_nodecreate']['existing_user'] = array(
      '#type' => 'fieldset',
      '#title' => t('Existing User'),
      '#description' => t('If you already have an account, please type in your login details '),
    );
    $form['anon_nodecreate'] ['existing_user'] ['form_fields'] = anon_nodecreate_get_user_form('user_login'); 

  }
}

function anon_nodecreate_get_user_form($form_id) {
  switch ($form_id) {
    case 'user_register':
      $form = drupal_retrieve_form('user_register', $form_state); 
      foreach($form as &$value) {
        if($value['#required']) {
          $value['#required'] = 0;
        } 

      }
      unset($form['submit']);
      return $form;
    break;
    case 'user_login':
      $form = drupal_retrieve_form('user_login', $form_state);
      foreach($form as &$value) {
        if($value['#required']) {
          $value['#required'] = 0;
        } 

      }
      unset($form['submit']); 
      return $form;    
    break;
  }
}
function anon_nodecreate_settings() {
  $form['anon_nodecreate'] ['option_set1'] = array(
    '#type' => 'fieldset',
    '#title' => 'User Registration Option',
  );
  $form['anon_nodecreate'] ['option_set1']['anon_create_register'] = array(
    '#type' => 'radios',
    '#title' => 'Registration fields',
    '#options' => array('0' => 'Use default registration fields',
       '1' => 'Provide only email field for registration',
       '2' => 'Provide email and username field for registration'
    ),
    '#default_value' => variable_get('anon_create_register', NULL),
    '#description' => 'Select the fields to be present while node is created anonymously',
  );

 return system_settings_form($form);
}

function neodsm($variable) {
  $debug = '<pre>' . print_r($variable, true) . '</pre>'; 
  drupal_set_message($debug);
}

